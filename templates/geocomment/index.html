{% extends "base.html" %}
{% load i18n %}

{% block style %}

	#map_canvas {
		height: 500px;
		width: 100%;
		margin-bottom: 18px;
	}
	
	#feedbackform {
		display: none;
	}
	
	#id_description {
		width: 100%;
		height: 80px;		
	}
	
{% endblock %}

{% block javascript %}
	
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
	<script type="text/javascript" src="{{ STATIC_URL }}js/ol/OpenLayers.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/cloudmade.js"></script>
	
	<script type="text/javascript">
		
		$(document).ready(function() {
        
        	var lon = -71.08;
			var lat = 42.35;
			var zoom = 12;
			var map, layer_cloudmade, layer_googsat, layer_paledawn, layer_bikeped, layer_walking, layer_regional, layer_markers, layer_feedback;
			var proj_wgs84, proj_osm;
			
			// Projections
			proj_wgs84 = new OpenLayers.Projection("EPSG:4326");
			proj_osm = new OpenLayers.Projection("EPSG:900913"); // really? 
			
			// Map
			map = new OpenLayers.Map("map_canvas", {
				controls: [
					new OpenLayers.Control.Navigation(),
					new OpenLayers.Control.PanZoom(),
					new OpenLayers.Control.LayerSwitcher(),
					new OpenLayers.Control.ScaleLine(),
					new OpenLayers.Control.Attribution()
				],
				restrictedExtent: new OpenLayers.Bounds(-72, 42, -70, 43).transform(proj_wgs84, proj_osm),
				maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
				maxResolution: 156543.0399,
				units: "m",
				projection: proj_osm,
				displayProjection: proj_wgs84
			});
			
			// Base Layer
			layer_paledawn = new OpenLayers.Layer.CloudMade("Pale Dawn", {
				key: '7a0df0d49fb14d27b35022fcb6b49d6d',
				styleId: 998
			});
			layer_cloudmade = new OpenLayers.Layer.CloudMade("Fresh", {
				key: '7a0df0d49fb14d27b35022fcb6b49d6d',
				styleId: 997
			});	
			layer_toposm = new OpenLayers.Layer.OSM("TopOSM", 
				"http://toposm.com/ma/final/${z}/${x}/${y}.png",
				{
					numZoomLevels: 16,
					attribution: "<a href='http://toposm.com/'>TopOSM</a>"
				}
			);		
			layer_googsat = new OpenLayers.Layer.Google("Google Satellite", {
				type: google.maps.MapTypeId.SATELLITE, 
				numZoomLevels: 22
			});
			
			// Overlays
			layer_regional = new OpenLayers.Layer.WMS("Regional Networks",
				"http://geonode.mapc.org/geoserver-geonode-dev/wms",
				{ 
					layers: "MAPC:bikeped_facilities",
					format: "image/png",
					styles: "Regional Networks", 
					transparent: true
					
				},
				{
					isBaseLayer: false,
					visibility: false,
					attribution: "<a href='http://mapc.org/'>MAPC</a>"
				}
			);
			layer_walking = new OpenLayers.Layer.WMS("Walking Facilites",
				"http://geonode.mapc.org/geoserver-geonode-dev/wms",
				{ 
					layers: "MAPC:bikeped_facilities",
					format: "image/png",
					styles: "Walking Facilities", 
					transparent: true
					
				},
				{
					isBaseLayer: false,
					visibility: false,
					attribution: "<a href='http://mapc.org/'>MAPC</a>"
				}
			);
			layer_bike = new OpenLayers.Layer.WMS("Bicycle Facilties",
				"http://geonode.mapc.org/geoserver-geonode-dev/wms",
				{ 
					layers: "MAPC:bikeped_facilities",
					format: "image/png",
					styles: "Bicycle Facilities", 
					transparent: true
					
				},
				{
					isBaseLayer: false,
					attribution: "<a href='http://mapc.org/'>MAPC</a>"
				}
			);
			layer_markers = new OpenLayers.Layer.Markers( "Feedback",
	            {
	            	visibility: false
	            }
            );
			
			// Map Functionality
			map.events.on({
				"moveend": function(e) {
					var mapcenter = map.getCenter().transform(proj_osm, proj_wgs84);
					$("#id_location").val("POINT(" + mapcenter.lon + " " + mapcenter.lat + ")")
				}
			});

            // add markers            
            function addMarker(ll, popupContent) {

	            var feature = new OpenLayers.Feature(layer_markers, ll); 
	            feature.closeBox = true;
	            feature.popupClass = OpenLayers.Class(OpenLayers.Popup.FramedCloud, {
            		"autoSize": true
        		});
	            feature.data.popupContentHTML = popupContent;
	            feature.data.overflow = "auto";
	                    
	            var marker = feature.createMarker();
	
	            var markerClick = function (evt) {
	                if (this.popup == null) {
	                    this.popup = this.createPopup(this.closeBox);
	                    map.addPopup(this.popup);
	                    this.popup.show();
	                } else {
	                    this.popup.toggle();
	                }
	                currentPopup = this.popup;
	                OpenLayers.Event.stop(evt);
	            };
	            marker.events.register("mousedown", feature, markerClick);
	
	            layer_markers.addMarker(marker);
        	}
        	
        	{% if feedback %}
        	
        	{% for marker in feedback %}
        	
            addMarker(new OpenLayers.LonLat({{ marker.location.x }},{{ marker.location.y }}).transform(proj_wgs84, proj_osm), "{{ marker.description }}<br><a href='{{ marker.get_absolute_url }}'>Add New Comment</a>");
            
            {% endfor %}
            
			{% endif %}
			
			// Compose map
			map.addLayers([layer_paledawn, layer_toposm, layer_cloudmade, layer_googsat, layer_bike, layer_walking, layer_regional, layer_markers]);
			map.setCenter( new OpenLayers.LonLat(lon, lat).transform(proj_wgs84, proj_osm), zoom );	
			
			// UI
			$("div.baseLbl").html("Base Layers");
			$("div.dataLbl").html("Bike/Ped Layers");
			
			// Feedbackform
			$("#feedbacklink").click(function() {
				$("#feedbackform").toggle("slow", function() {
					$("#feedbacklink").unbind();					

            		// Add draggable marker/feature            		
            		var layer_feedback = new OpenLayers.Layer.Vector("Your Feedback");
    				layer_feedback.styleMap = new OpenLayers.StyleMap(new OpenLayers.Style({				        
					        graphicYOffset: -25,
					        graphicXOffset: -13,
					        externalGraphic: "{{ STATIC_URL }}js/ol/img/marker-green.png",
					        pointRadius: 13
					    })
				    );            		
            		var feedback_pt = new OpenLayers.Geometry.Point(map.getCenter().lon, map.getCenter().lat)
					var feedback_feature = new OpenLayers.Feature.Vector(feedback_pt);
            		
            		layer_feedback.addFeatures([feedback_feature]);
					map.addLayer(layer_feedback);
            		
            		map.addControl(new OpenLayers.Control.MousePosition());
            		var feedback_drag = new OpenLayers.Control.DragFeature(layer_feedback);
            		feedback_drag.onComplete = function(f) {            			
            			var feedback_lonlat = new OpenLayers.LonLat(feedback_feature.geometry.x, feedback_feature.geometry.y);
            			feedback_lonlat.transform(proj_osm, proj_wgs84);            			
            			$("#id_location").val("POINT(" + feedback_lonlat.lon + " " + feedback_lonlat.lat + ")")						
            			console.log($("#id_location").val());
            		}
            		map.addControl(feedback_drag);
            		feedback_drag.activate();            		
  				});				
			});
			$("#feedbackform").submit(function() {
				// simple validation
				if (!$("#id_description").val()) {
					alert("Please fill out the form.");
				  	return false;
				}
			});
        
        });
    </script> 
	
{% endblock %}
	
{% block map %}

		</div>
		
		<div id="map_canvas"></div>
		
		<div class="container">

{% endblock %}
		
{% block body %}

		<div id="content" class="prepend-2 span-20 append-2 prepend-top last">
			
			<p class="large"><a id="feedbacklink" href="#">Provide Feedback</a></p>
			
			<form id="feedbackform" action="/feedback/new/" method="post">
	
				{% csrf_token %}
					
				<div>Please drag the green marker <img src="{{ STATIC_URL }}js/ol/img/marker-green.png" height="18" alt="green marker" /> to your desired location and use the form below for submitting your feedback:</div>
				
				{{ form.location }}
				
				<div class="form-row">
				{% if form.title.errors %}
				<div class="error">
					{% for error in form.description.errors %}
						{{ error|escape }}<br>
					{% endfor %}
					{{ form.description }}
				</div>
				{% else %}
				{{ form.description }}
				{% endif %}	
				</div>
		
				<input type="submit" value="Submit Feedback!" />
			
			</form>

		</div>

{% endblock %}
