{% extends "base.html" %}
{% load i18n %}
{% load disqus_tags %}

{% block style %}

	#map_canvas {
		height: 500px;
		width: 100%;
		margin-bottom: 18px;
	}
	
	#feedbackform {
		display: none;
	}
	
	#id_description {
		width: 100%;
		height: 80px;		
	}
	
	#disclaimer {
		font-style: italic;
	}
	
	#map_legend li {
		display: inline;
		list-style-type: none;
		margin-right: 8px;
		white-space: nowrap;
	}
	#map_legend img {
		width: 12px;
		height: 12px;
	}
	
{% endblock %}

{% block javascript %}
	
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
	<script type="text/javascript" src="{{ STATIC_URL }}js/ol/OpenLayers.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/cloudmade.js"></script>
	
	<script type="text/javascript">
		
		$(document).ready(function() {
        
        	var lon = {{ feedback.location.x }};
			var lat = {{ feedback.location.y }};
			var zoom = 14;
			var map, layer_switcher, layer_osm, layer_googsat, layer_paledawn, layer_bikeped, layer_walking, layer_regional, layer_markers;
			var proj_wgs84, proj_osm;
			var marker, feature;
			
			// Projections
			proj_wgs84 = new OpenLayers.Projection("EPSG:4326");
			proj_osm = new OpenLayers.Projection("EPSG:900913"); // really? 
			
			// Map
			var layer_switcher = new OpenLayers.Control.LayerSwitcher();
			map = new OpenLayers.Map("map_canvas", {
				controls: [
					new OpenLayers.Control.Navigation(),
					new OpenLayers.Control.PanZoom(),
					layer_switcher,
					new OpenLayers.Control.ScaleLine(),
					new OpenLayers.Control.Attribution()
				],
				restrictedExtent: new OpenLayers.Bounds(-74, 41, -69, 43).transform(proj_wgs84, proj_osm),
				maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
				maxResolution: 156543.0399,
				units: "m",
				projection: proj_osm,
				displayProjection: proj_wgs84
			});
			
			// Usability issue: people didn't find the layer switcher.
			layer_switcher.maximizeControl();
			
			// Base Layer
			layer_paledawn = new OpenLayers.Layer.CloudMade("Pale Dawn", {
				key: '7a0df0d49fb14d27b35022fcb6b49d6d',
				styleId: 998
			});
			layer_osm = new OpenLayers.Layer.OSM("OpenStreetMap");	
			layer_toposm = new OpenLayers.Layer.OSM("TopOSM", 
				"http://toposm.com/ma/final/${z}/${x}/${y}.png",
				{
					numZoomLevels: 16,
					attribution: "<a href='http://toposm.com/'>TopOSM</a>"
				}
			);		
			layer_googsat = new OpenLayers.Layer.Google("Google Satellite", {
				type: google.maps.MapTypeId.SATELLITE, 
				numZoomLevels: 22
			});
			
			// Overlays
			layer_regional = new OpenLayers.Layer.WMS("Regional Networks",
				"http://geonode.mapc.org/geoserver-geonode-dev/wms",
				{ 
					layers: "MAPC:bikeped_facilities",
					format: "image/png",
					styles: "Regional Networks", 
					transparent: true
					
				},
				{
					isBaseLayer: false,
					visibility: false,
					attribution: "<a href='http://mapc.org/'>MAPC</a>"
				}
			);
			layer_walking = new OpenLayers.Layer.WMS("Paths and Trails",
				"http://geonode.mapc.org/geoserver-geonode-dev/wms",
				{ 
					layers: "MAPC:bikeped_facilities",
					format: "image/png",
					styles: "Walking Facilities", 
					transparent: true
					
				},
				{
					isBaseLayer: false,
					attribution: "<a href='http://mapc.org/'>MAPC</a>"
				}
			);
			layer_bike = new OpenLayers.Layer.WMS("Bicycle Facilities (on-road)",
				"http://geonode.mapc.org/geoserver-geonode-dev/wms",
				{ 
					layers: "MAPC:bikeped_facilities",
					format: "image/png",
					styles: "Bicycle Facilities", 
					transparent: true
					
				},
				{
					isBaseLayer: false,
					attribution: "<a href='http://mapc.org/'>MAPC</a>"
				}
			);
			layer_markers = new OpenLayers.Layer.Markers( "Feedback" );
			
			// Compose
			map.addLayers([layer_paledawn, layer_osm, layer_toposm, layer_googsat, layer_regional, layer_walking, layer_bike, layer_markers]);
			map.setCenter( new OpenLayers.LonLat(lon, lat).transform(proj_wgs84, proj_osm), zoom );		
			map.addControl(new OpenLayers.Control.Permalink());
			
			// Map Functionality        	
            // add markers
            function addMarker(ll, popupContent) {

	            var feature = new OpenLayers.Feature(layer_markers, ll); 
	            feature.closeBox = true;
	            feature.popupClass = OpenLayers.Class(OpenLayers.Popup.FramedCloud, {
            		"autoSize": true
        		});
	            feature.data.popupContentHTML = popupContent;
	            feature.data.overflow = "auto";
	                    
	            var marker = feature.createMarker();
	
	            var markerClick = function (evt) {
	                if (this.popup == null) {
	                    this.popup = this.createPopup(this.closeBox);
	                    map.addPopup(this.popup);
	                    this.popup.show();
	                } else {
	                    this.popup.toggle();
	                }
	                currentPopup = this.popup;
	                OpenLayers.Event.stop(evt);
	            };
	            marker.events.register("mousedown", feature, markerClick);
	
	            layer_markers.addMarker(marker);
        	}
        	
            addMarker(new OpenLayers.LonLat({{ feedback.location.x }},{{ feedback.location.y }}).transform(proj_wgs84, proj_osm), "{{ feedback.description }}");
            
			
			// UI
			$("div.baseLbl").html("Base Layers");
			$("div.dataLbl").html("Bike/Ped Layers");
			
        
        });
    </script> 
	
{% endblock %}
	
{% block map %}
		
		<div id="map_canvas"></div>
		
		<ul id="map_legend">			
			<li><img src="{{ STATIC_URL }}img/ct.png" alt="icon" />Cycle track</li>
			<li><img src="{{ STATIC_URL }}img/bl.png" alt="icon" />Bike lane</li>
			<li><img src="{{ STATIC_URL }}img/sl.png" alt="icon" />Shared lane</li>
			<li><img src="{{ STATIC_URL }}img/or.png" alt="icon" />On-road route</li>
			<li><img src="{{ STATIC_URL }}img/e.png" alt="icon" />Improved path</li>
			<li><img src="{{ STATIC_URL }}img/u.png" alt="icon" />Unimproved path</li>
			<li><img src="{{ STATIC_URL }}img/t.png" alt="icon" />Walking path or trail</li>
			<li><img src="{{ STATIC_URL }}img/w.png" alt="icon" />Water trail</li>
			<li><img src="{{ STATIC_URL }}img/lw.png" alt="icon" />Regional or local walking trail</li>
			<li><img src="{{ STATIC_URL }}img/lb.png" alt="icon" />Regional bicycle route</li>
			<li><img src="{{ STATIC_URL }}img/p.png" alt="icon" />Proposed facility</li>
		</ul>
		
{% endblock %}
		
{% block body %}

		<div id="content" class="prepend-2 span-20 append-2 prepend-top last">
			
			<p class="large">{{ feedback.description }}</p>
			
			{% set_disqus_identifier "feedback_" feedback.id %}
			{% set_disqus_url "http://trailmap.mapc.org" feedback.get_absolute_url %}
			{% set_disqus_title "Feedback-" feedback.id %}
			
			{% disqus_show_comments %}
			
			<p id="disclaimer" class="prepend-top">Disclaimer: 
				The data herein is provided as is and for information purposes only. MAPC does not guarantee its completeness or accuracy. 
				This project is a work in progress. Weather, traffic, construction or other events out of MAPCâ€™s control may affect the utility 
				of the data provided. Plan accordingly and use caution, obey all applicable laws and follow generally accepted practices when 
				using these facilities.</p>

		</div>

{% endblock %}
