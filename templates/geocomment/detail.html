{% extends "base.html" %}
{% load i18n %}
{% load disqus_tags %}

{% block style %}

	#map_canvas {
		height: 500px;
		width: 100%;
		margin-bottom: 18px;
	}
	
	#feedbackform {
		display: none;
	}
	
	#id_description {
		width: 100%;
		height: 80px;		
	}
	
{% endblock %}

{% block javascript %}
	
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
	<script type="text/javascript" src="{{ STATIC_URL }}js/ol/OpenLayers.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/cloudmade.js"></script>
	
	<script type="text/javascript">
		
		$(document).ready(function() {
        
        	var lon = {{ feedback.location.x }};
			var lat = {{ feedback.location.y }};
			var zoom = 14;
			var map, layer_cloudmade, layer_googsat, layer_paledawn, layer_bikeped, layer_walking, layer_regional, layer_markers;
			var proj_wgs84, proj_osm;
			var marker, feature, marker_ll, marker_desc, size, offset, icon;
			
			// Projections
			proj_wgs84 = new OpenLayers.Projection("EPSG:4326");
			proj_osm = new OpenLayers.Projection("EPSG:900913"); // really? 
			
			// Map
			map = new OpenLayers.Map("map_canvas", {
				controls: [
					new OpenLayers.Control.Navigation(),
					new OpenLayers.Control.PanZoom(),
					new OpenLayers.Control.LayerSwitcher(),
					new OpenLayers.Control.ScaleLine(),
					new OpenLayers.Control.Attribution()
				],
				eventListeners: {
					// "moveend": console.log("move"),
					// "zoomend": console.log("move")
				},
				restrictedExtent: new OpenLayers.Bounds(-72, 42, -70, 43).transform(proj_wgs84, proj_osm),
				maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
				maxResolution: 156543.0399,
				units: "m",
				projection: proj_osm,
				displayProjection: proj_wgs84
			});
			
			// Base Layer
			layer_paledawn = new OpenLayers.Layer.CloudMade("Pale Dawn", {
				key: '7a0df0d49fb14d27b35022fcb6b49d6d',
				styleId: 998
			});
			layer_cloudmade = new OpenLayers.Layer.CloudMade("CloudMade", {
				key: '7a0df0d49fb14d27b35022fcb6b49d6d',
				styleId: 1
			});	
			layer_toposm = new OpenLayers.Layer.OSM("TopOSM", 
				"http://toposm.com/ma/final/${z}/${x}/${y}.png",
				{
					numZoomLevels: 16,
					attribution: "<a href='http://toposm.com/'>TopOSM</a>"
				}
			);		
			layer_googsat = new OpenLayers.Layer.Google("Google Satellite", {
				type: google.maps.MapTypeId.SATELLITE, 
				numZoomLevels: 22
			});
			
			// Overlays
			layer_regional = new OpenLayers.Layer.WMS("Regional Networks",
				"http://geonode.mapc.org/geoserver-geonode-dev/wms",
				{ 
					layers: "MAPC:bikeped_facilities",
					format: "image/png",
					styles: "Regional Networks", 
					transparent: true
					
				},
				{
					isBaseLayer: false,
					visibility: false,
					attribution: "<a href='http://mapc.org/'>MAPC</a>"
				}
			);
			layer_walking = new OpenLayers.Layer.WMS("Walking Facilites",
				"http://geonode.mapc.org/geoserver-geonode-dev/wms",
				{ 
					layers: "MAPC:bikeped_facilities",
					format: "image/png",
					styles: "Walking Facilities", 
					transparent: true
					
				},
				{
					isBaseLayer: false,
					visibility: false,
					attribution: "<a href='http://mapc.org/'>MAPC</a>"
				}
			);
			layer_bike = new OpenLayers.Layer.WMS("Bicycle Facilties",
				"http://geonode.mapc.org/geoserver-geonode-dev/wms",
				{ 
					layers: "MAPC:bikeped_facilities",
					format: "image/png",
					styles: "Bicycle Facilities", 
					transparent: true
					
				},
				{
					isBaseLayer: false,
					attribution: "<a href='http://mapc.org/'>MAPC</a>"
				}
			);
			
			// Compose
			map.addLayers([layer_paledawn, layer_toposm, layer_cloudmade, layer_googsat, layer_bike, layer_walking, layer_regional]);
			map.setCenter( new OpenLayers.LonLat(lon, lat).transform(proj_wgs84, proj_osm), zoom );		
			
			// Map Functionality
			layer_markers = new OpenLayers.Layer.Markers( "Feedback" );
            map.addLayer(layer_markers);
/*
            size = new OpenLayers.Size(21,25);
           	offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
           	icon = new OpenLayers.Icon("{{ STATIC_URL }}js/ol/img/marker.png",size,offset);
           	marker = new OpenLayers.Marker(new OpenLayers.LonLat({{ feedback.location.x }},{{ feedback.location.y }}).transform(proj_wgs84, proj_osm),icon);
           	marker.events.register("mousedown", marker, function(evt) {
           		
           		var popup = new OpenLayers.Popup.AnchoredBubble("popup_"+this.id, 
           			new OpenLayers.LonLat(marker.lonlat.lon, marker.lonlat.lat),
           			new OpenLayers.Size(200,200),
           			"popup showing",
           			true);
           		// popup.lonlat = marker.lonlat;
           		map.addPopup(popup);
           	});
            
            layer_markers.addMarker(marker);
            */
            AutoSizeFramedCloud = OpenLayers.Class(OpenLayers.Popup.FramedCloud, {
            	'autoSize': true
        	});
        	
        	//add marker
            marker_ll = new OpenLayers.LonLat({{ feedback.location.x }},{{ feedback.location.y }}).transform(proj_wgs84, proj_osm);
            marker_desc = "{{ feedback.description }}";
            addMarker(new OpenLayers.LonLat({{ feedback.location.x }},{{ feedback.location.y }}).transform(proj_wgs84, proj_osm), "{{ feedback.description }}");
            
            function addMarker(ll, popupContent) {

	            var feature = new OpenLayers.Feature(layer_markers, ll); 
	            feature.closeBox = true;
	            feature.popupClass = OpenLayers.Class(OpenLayers.Popup.FramedCloud, {
            		"autoSize": true
        		});
	            feature.data.popupContentHTML = popupContent;
	            feature.data.overflow = "auto";
	                    
	            var marker = feature.createMarker();
	
	            var markerClick = function (evt) {
	                if (this.popup == null) {
	                    this.popup = this.createPopup(this.closeBox);
	                    map.addPopup(this.popup);
	                    this.popup.show();
	                } else {
	                    this.popup.toggle();
	                }
	                currentPopup = this.popup;
	                OpenLayers.Event.stop(evt);
	            };
	            marker.events.register("mousedown", feature, markerClick);
	
	            layer_markers.addMarker(marker);
        	}
            

			
			// UI
			$("div.baseLbl").html("Base Layers");
			$("div.dataLbl").html("Bike/Ped Layers");
			
        
        });
    </script> 
	
{% endblock %}
	
{% block map %}

		</div>
		
		<div id="map_canvas"></div>
		
		<div class="container">

{% endblock %}
		
{% block body %}

		<div id="content" class="prepend-2 span-20 append-2 prepend-top last">
			
			<p class="large">{{ feedback.description }}</p>
			
			{% disqus_dev %}
			{% set_disqus_developer 1 %}
			
			{% set_disqus_identifier "feedback_" feedback.id %}
			{% set_disqus_url feedback.get_absolute_url %}
			{% set_disqus_title "Feedback" feedback.id %}
			
			{% disqus_show_comments %}

		</div>

{% endblock %}
